<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Durga Puja 2025 Route with AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; right: 0; left: 0; }
        
        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #2196F3, #1976D2, #0D47A1);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.3);
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Sidebar */
        .sidebar {
            position: absolute;
            top: 100px;
            left: 20px;
            width: 350px;
            max-height: calc(100vh - 140px);
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .sidebar.collapsed {
            transform: translateX(-320px);
        }
        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: linear-gradient(90deg, #E3F2FD, #BBDEFB);
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #546E7A;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: white;
            color: #1976D2;
            border-bottom: 3px solid #2196F3;
            box-shadow: 0 -2px 8px rgba(33, 150, 243, 0.2);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }
        .tab-content.active {
            display: block;
        }

        /* Pandal List */
        .pandal-item {
            background: linear-gradient(135deg, #F3F9FF, #E8F4FD);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.1);
        }
        .pandal-item:hover {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.15);
            border-left: 4px solid #1976D2;
        }
        .pandal-name {
            font-weight: 600;
            color: #0D47A1;
            margin-bottom: 5px;
        }
        .pandal-desc {
            font-size: 0.9rem;
            color: #37474F;
        }
        .pandal-time {
            font-size: 0.8rem;
            color: #1976D2;
            font-weight: 500;
            margin-top: 5px;
        }

        /* Chatbot */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 220px);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            margin-bottom: 15px;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message.user {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
            flex-shrink: 0;
        }
        .message.user .message-avatar {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }
        .message.bot .message-avatar {
            background: linear-gradient(135deg, #607D8B, #455A64);
        }
        .message-content {
            background: #F8FAFE;
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            font-size: 0.9rem;
            line-height: 1.4;
            border: 1px solid rgba(33, 150, 243, 0.05);
        }
        .message.user .message-content {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #E1F5FE;
            border-radius: 25px;
            outline: none;
            font-size: 0.9rem;
            background: #F8FFFE;
        }
        .chat-input:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        .chat-send {
            padding: 12px 20px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        .chat-send:hover {
            background: linear-gradient(135deg, #1976D2, #0D47A1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Loading indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Route Controls */
        .route-controls {
            position: absolute;
            top: 120px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .route-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 3px 10px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .route-btn:hover {
            background: linear-gradient(135deg, #1976D2, #0D47A1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        /* Enhanced tooltips */
        .blue-tooltip {
            background: linear-gradient(135deg, #1976D2, #0D47A1) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 500 !important;
        }
        
        /* Route line styling */
        .route-line {
            filter: drop-shadow(0 2px 4px rgba(33, 150, 243, 0.3));
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: calc(100vw - 40px);
                left: 20px;
            }
            .sidebar.collapsed {
                transform: translateX(calc(-100vw + 20px));
            }
            .header h1 {
                font-size: 1.2rem;
            }
            .route-controls {
                right: 10px;
                top: 110px;
            }
            .route-btn {
                padding: 10px 14px;
                font-size: 13px;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-route"></i> Durga Puja 2025 Route Planner</h1>
        <p>Barrackpore → South Kolkata | 2:00 PM - 10:00 PM</p>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Route Controls -->
    <div class="route-controls">
        <button class="route-btn" onclick="toggleRoute()" title="Toggle route visibility">
            <i class="fas fa-route"></i> Toggle Route
        </button>
        <button class="route-btn" onclick="fitToRoute()" title="Fit map to show all pandals">
            <i class="fas fa-expand-arrows-alt"></i> Fit Route
        </button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left" id="toggle-icon"></i>
        </button>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('pandals')">
                <i class="fas fa-map-marker-alt"></i> Pandals
            </button>
            <button class="tab" onclick="switchTab('chat')">
                <i class="fas fa-robot"></i> AI Guide
            </button>
        </div>

        <!-- Pandals Tab -->
        <div class="tab-content active" id="pandals-tab">
            <div id="pandal-list"></div>
        </div>

        <!-- Chat Tab -->
        <div class="tab-content" id="chat-tab">
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot">
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">
                            Hello! I'm your Durga Puja guide. Ask me anything about the pandals, routes, timings, or festival traditions! 🎭
                        </div>
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask about pandals, routes, timings..." onkeypress="handleChatKeyPress(event)">
                    <button class="chat-send" id="chat-send" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    var map = L.map("map", {
        center: [22.6, 88.4],
        zoom: 11
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Data © OpenStreetMap contributors"
    }).addTo(map);

    // Mistral AI API Configuration
    const MISTRAL_API_KEY = 'ekRUzFZQh6nDfdYJfTclsWgqRSNT472L';
    const MISTRAL_API_URL = 'https://api.mistral.ai/v1/chat/completions';

    // Comprehensive Durga Puja Route 2025 - Starting from Barrackpore
    var pujas = [
        {
            name: "🚩 Barrackpore (Starting Point)",
            coords: [22.7674, 88.37],
            desc: "Journey begins! Historic town with Mangal Pandey memorial. Grab breakfast & start your Durga Puja adventure! ☀️",
            time: "9:00 AM",
            timeSlot: "9:00 – 9:30 am",
            category: "starting-point",
            theme: "Starting Point",
            travelTime: "0 min",
            tips: "Best parking near station area"
        },
        {
            name: "Tala Prattoy",
            coords: [22.6103, 88.3456],
            desc: "🌱 Beej Angan (Seed Arena) - Centenary celebration focusing on sustainability & agriculture. Great morning visit!",
            time: "10:00 AM",
            timeSlot: "9:30 – 11:00 am",
            category: "north-cluster",
            theme: "Beej Angan",
            travelTime: "30 min from Barrackpore",
            tips: "Less crowded in morning"
        },
        {
            name: "Dum Dum Park Tarun Sangha",
            coords: [22.6125, 88.4036],
            desc: "🕵️ Byomkesh Bakshi Mysteries - Interactive detective fiction theme with dramatic storytelling. Must-see!",
            time: "11:30 AM",
            timeSlot: "11:00 – 12:30 pm",
            category: "north-cluster",
            theme: "Byomkesh Bakshi",
            travelTime: "15 min from Tala",
            tips: "Famous for innovative themes"
        },
        {
            name: "Kumartuli Park",
            coords: [22.6048, 88.3642],
            desc: "🏺 Artisan's Hub - Near the famous idol-makers' quarter. Traditional craftsmanship meets spiritual devotion.",
            time: "1:00 PM",
            timeSlot: "12:30 – 2:00 pm",
            category: "north-heritage",
            theme: "Artisan Heritage",
            travelTime: "20 min from Dum Dum",
            tips: "Visit idol-making workshops nearby"
        },
        {
            name: "Jagat Mukherjee Park",
            coords: [22.5958, 88.3675],
            desc: "🎨 Cultural Heritage - One of North Kolkata's prestigious pandals known for artistic excellence and traditions.",
            time: "2:30 PM",
            timeSlot: "2:00 – 3:30 pm",
            category: "north-heritage",
            theme: "Cultural Heritage",
            travelTime: "15 min from Kumartuli",
            tips: "Rich cultural programs"
        },
        {
            name: "Ahiritola Sarbojanin",
            coords: [22.6017, 88.3639],
            desc: "🎭 Flow - Mesmerizing mime performances exploring life's transformations. Peaceful & artistic experience.",
            time: "4:00 PM",
            timeSlot: "3:30 – 5:00 pm",
            category: "north-heritage",
            theme: "Flow",
            travelTime: "10 min from Jagat Mukherjee",
            tips: "Heritage puja, traditional vibes"
        },
        {
            name: "Kashi Bose Lane",
            coords: [22.5819, 88.3678],
            desc: "📚 Leela Majumdar's World - Whimsical puppet shows & literary tribute. Perfect for families with kids!",
            time: "5:30 PM",
            timeSlot: "5:00 – 6:30 pm",
            category: "north-heritage",
            theme: "Literary Tribute",
            travelTime: "12 min from Ahiritola",
            tips: "Great for literature lovers"
        },
        {
            name: "Santosh Mitra Square",
            coords: [22.5664, 88.3503],
            desc: "🇮🇳 Operation Sindoor - Powerful military tribute honoring Armed Forces. Patriotic & inspiring theme.",
            time: "7:00 PM",
            timeSlot: "6:30 – 8:00 pm",
            category: "central-kolkata",
            theme: "Military Tribute",
            travelTime: "15 min from Kashi Bose",
            tips: "Evening lighting is spectacular"
        },
        {
            name: "Badamtala Ashar Sangha",
            coords: [22.5489, 88.3567],
            desc: "🌟 Community Pride - Famous for innovative themes and strong community participation. Always a crowd favorite!",
            time: "8:30 PM",
            timeSlot: "8:00 – 9:30 pm",
            category: "central-transition",
            theme: "Community Spirit",
            travelTime: "12 min from Santosh Mitra",
            tips: "Great food stalls nearby"
        },
        {
            name: "Suruchi Sangha",
            coords: [22.5264, 88.3497],
            desc: "🌍 International Fusion - Grand setup with modern interpretations. Known for celebrity visits & grandeur.",
            time: "10:00 PM",
            timeSlot: "9:30 – 11:00 pm",
            category: "south-premium",
            theme: "International Fusion",
            travelTime: "10 min from Badamtala",
            tips: "Prime time - expect crowds"
        },
        {
            name: "66 Palli Club",
            coords: [22.5278, 88.3542],
            desc: "🎯 Innovation Hub - Known for unique themes and modern artistic interpretations. Always pushes creative boundaries.",
            time: "11:30 PM",
            timeSlot: "11:00 – 12:00 am",
            category: "south-premium",
            theme: "Modern Innovation",
            travelTime: "8 min from Suruchi",
            tips: "Late night visit for less crowds"
        },
        {
            name: "Ekdalia Evergreen",
            coords: [22.5177, 88.3579],
            desc: "🌿 Classic Charm - Traditional South Kolkata puja with evergreen appeal. Beloved by locals for its authentic feel.",
            time: "12:30 AM",
            timeSlot: "12:00 – 1:00 am (Day 2)",
            category: "south-classic",
            theme: "Traditional Charm",
            travelTime: "10 min from 66 Palli",
            tips: "Perfect midnight darshan"
        },
        {
            name: "Tridhara Sammilani",
            coords: [22.5236, 88.3534],
            desc: "⚡ Trinity Power - Blend of tradition and innovation. Artistic installations that mesmerize visitors.",
            time: "1:30 AM",
            timeSlot: "1:00 – 2:00 am (Day 2)",
            category: "south-artistic",
            theme: "Trinity & Innovation",
            travelTime: "8 min from Ekdalia",
            tips: "Artistic installations worth seeing"
        },
        {
            name: "Deshapriya Park",
            coords: [22.5167, 88.351],
            desc: "🏆 Record Breaker - Huge open ground pandal often featuring record-breaking Durga idols. Massive scale!",
            time: "2:30 AM",
            timeSlot: "2:00 – 3:00 am (Day 2)",
            category: "south-grandeur",
            theme: "Grand Scale",
            travelTime: "10 min from Tridhara",
            tips: "Famous for giant installations"
        },
        {
            name: "Chetla Agrani",
            coords: [22.5258, 88.3264],
            desc: "� Contemporary Creativity - Known for innovative designs and contemporary themes. Always surprising visitors!",
            time: "3:30 AM",
            timeSlot: "3:00 – 4:00 am (Day 2)",
            category: "south-contemporary",
            theme: "Contemporary Art",
            travelTime: "15 min from Deshapriya",
            tips: "Innovative contemporary designs"
        },
        {
            name: "41 Palli Club",
            coords: [22.5353, 88.3603],
            desc: "🚀 Futuristic Vision - Traditional meets modern design. Innovative tech integration with classic themes.",
            time: "4:00 AM",
            timeSlot: "4:00 – 5:00 am (Day 2)",
            category: "south-finale",
            theme: "Future Vision",
            travelTime: "12 min from Chetla",
            tips: "Early morning peaceful visit"
        }
    ];    
    
    // Custom marker icons for expanded route
    var markerIcons = {
        'starting-point': '🚩',
        'north-cluster': '🎭',
        'north-heritage': '🏛️',
        'central-kolkata': '🏛️',
        'central-transition': '🌉',
        'south-premium': '⭐',
        'south-classic': '🌿',
        'south-artistic': '🎨',
        'south-grandeur': '🏆',
        'south-contemporary': '�',
        'south-finale': '✨'
    };

    // Route line variable for toggling
    var routeLine = null;
    var markers = [];
    
    // Add enhanced markers with blue theme
    var latlngs = [];
    pujas.forEach(function(p, index){
        var customIcon = L.divIcon({
            html: `<div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 3px 12px rgba(33, 150, 243, 0.4); position: relative;">
                <span style="position: absolute; top: -8px; right: -8px; background: #0D47A1; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">${index + 1}</span>
                ${markerIcons[p.category] || '📍'}
            </div>`,
            className: 'custom-marker',
            iconSize: [35, 35],
            iconAnchor: [17, 17]
        });
        
        var marker = L.marker(p.coords, {icon: customIcon}).addTo(map);
        marker.bindPopup(`
            <div style="min-width: 250px; font-family: 'Inter', sans-serif;">
                <h3 style="margin: 0 0 10px 0; color: #1976D2; font-size: 16px;">${p.name}</h3>
                <p style="margin: 0 0 10px 0; font-size: 13px; color: #37474F; line-height: 1.4;">${p.desc}</p>
                <div style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); padding: 10px; border-radius: 8px; font-size: 12px; border-left: 3px solid #2196F3;">
                    <strong style="color: #0D47A1;">⏰ ${p.timeSlot}</strong><br>
                    <span style="color: #1976D2;">📍 Stop #${index + 1} | ${p.travelTime}</span><br>
                    <span style="color: #546E7A;">💡 ${p.tips}</span>
                </div>
            </div>
        `);
        marker.bindTooltip(`${index + 1}. ${p.name} (${p.time})`, {sticky: true, className: 'blue-tooltip'});
        markers.push(marker);
        latlngs.push(p.coords);
    });

    // Enhanced route mapping with segments
    function drawRoute() {
        if (routeLine) {
            map.removeLayer(routeLine);
        }
        
        // Draw main route line
        routeLine = L.polyline(latlngs, {
            color: "#2196F3", 
            weight: 4, 
            opacity: 0.8,
            dashArray: '8, 4',
            className: 'route-line'
        }).addTo(map);
        
        // Add direction arrows
        for (let i = 0; i < latlngs.length - 1; i++) {
            const start = latlngs[i];
            const end = latlngs[i + 1];
            const midpoint = [(start[0] + end[0]) / 2, (start[1] + end[1]) / 2];
            
            // Calculate arrow direction
            const angle = Math.atan2(end[1] - start[1], end[0] - start[0]) * 180 / Math.PI;
            
            const arrowIcon = L.divIcon({
                html: `<div style="transform: rotate(${angle + 90}deg); color: #1976D2; font-size: 14px; text-shadow: 1px 1px 2px white;">▶</div>`,
                className: 'route-arrow',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker(midpoint, {icon: arrowIcon}).addTo(map);
        }
        
        // Add distance markers
        let totalDistance = 0;
        for (let i = 0; i < latlngs.length - 1; i++) {
            const distance = calculateDistance(latlngs[i], latlngs[i + 1]);
            totalDistance += distance;
        }
        
        console.log(`Total route distance: ${totalDistance.toFixed(1)} km`);
    }
    
    // Calculate distance between two points
    function calculateDistance(point1, point2) {
        const R = 6371; // Earth's radius in km
        const dLat = (point2[0] - point1[0]) * Math.PI / 180;
        const dLon = (point2[1] - point1[1]) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(point1[0] * Math.PI / 180) * Math.cos(point2[0] * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    // Draw initial route
    drawRoute();

    // Initialize sidebar with pandal list
    function initializePandalList() {
        const pandalList = document.getElementById('pandal-list');
        const timeSlots = {
            "9:00 – 9:30 am": "🚩 Journey Begins",
            "9:30 – 11:00 am": "🌅 Morning North Cluster",
            "11:00 – 12:30 pm": "🎭 Dum Dum Area",
            "12:30 – 2:00 pm": "🏺 Heritage Artisan Quarter",
            "2:00 – 3:30 pm": "🎨 Cultural Heritage Zone",
            "3:30 – 5:00 pm": "🎭 Traditional North Kolkata",
            "5:00 – 6:30 pm": "📚 Literary & Cultural",
            "6:30 – 8:00 pm": "🇮🇳 Central Kolkata",
            "8:00 – 9:30 pm": "🌟 Evening Transition",
            "9:30 – 11:00 pm": "⭐ Premium South Circuit",
            "11:00 – 12:00 am": "🎯 Late Night Innovation",
            "12:00 – 1:00 am": "🌿 Classic Midnight",
            "1:00 – 2:00 am": "⚡ Artistic Trinity",
            "2:00 – 3:00 am": "🏆 Grand Scale",
            "3:00 – 4:00 am": "🎨 Contemporary",
            "4:00 – 5:00 am": "🚀 Dawn Finale"
        };

        Object.entries(timeSlots).forEach(([timeSlot, sectionName]) => {
            const sectionPandals = pujas.filter(p => p.timeSlot.includes(timeSlot.split(' –')[0]));
            if (sectionPandals.length > 0) {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `
                    <h4 style="color: #1976D2; margin: 20px 0 10px 0; font-size: 1rem; border-bottom: 2px solid #E3F2FD; padding-bottom: 5px; background: linear-gradient(90deg, #F3F9FF, transparent); padding: 8px 0; border-radius: 4px;">
                        📍 ${sectionName}
                    </h4>
                `;
                pandalList.appendChild(sectionDiv);

                sectionPandals.forEach((pandal, index) => {
                    const pandalDiv = document.createElement('div');
                    pandalDiv.className = 'pandal-item';
                    pandalDiv.innerHTML = `
                        <div class="pandal-name">${markerIcons[pandal.category]} ${pandal.name}</div>
                        <div class="pandal-desc">${pandal.desc}</div>
                        <div class="pandal-time">${pandal.time} • ${pandal.timeSlot}</div>
                    `;
                    pandalDiv.onclick = () => {
                        map.setView(pandal.coords, 15);
                        // Find and open the marker popup
                        map.eachLayer(layer => {
                            if (layer instanceof L.Marker && 
                                layer.getLatLng().lat === pandal.coords[0] && 
                                layer.getLatLng().lng === pandal.coords[1]) {
                                layer.openPopup();
                            }
                        });
                    };
                    pandalList.appendChild(pandalDiv);
                });
            }
        });
    }

    // Route control functions
    function toggleRoute() {
        if (routeLine) {
            if (map.hasLayer(routeLine)) {
                map.removeLayer(routeLine);
                // Remove arrows too
                map.eachLayer(layer => {
                    if (layer.options && layer.options.icon && layer.options.icon.options.className === 'route-arrow') {
                        map.removeLayer(layer);
                    }
                });
            } else {
                drawRoute();
            }
        }
    }
    
    // Fit map to show all pandals
    function fitToRoute() {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Sidebar functions
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const icon = document.getElementById('toggle-icon');
        sidebar.classList.toggle('collapsed');
        icon.className = sidebar.classList.contains('collapsed') ? 
            'fas fa-chevron-right' : 'fas fa-chevron-left';
    }

    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Chat functions
    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';
        document.getElementById('chat-send').disabled = true;
        showTypingIndicator();

        try {
            const response = await fetch(MISTRAL_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${MISTRAL_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'mistral-small-latest',
                    messages: [
                        {
                            role: 'system',
                            content: `You are a knowledgeable Durga Puja guide for Kolkata. You know about the pandals in this route: ${pujas.map(p => `${p.name} (${p.timeSlot}): ${p.desc}`).join('; ')}. 
                            
                            Provide helpful, enthusiastic responses about Durga Puja pandals, Bengali culture, travel tips, timings, and festival traditions. Keep responses concise but informative. Use emojis when appropriate.
                            
                            Today's route is: Barrackpore → Dum Dum → North Kolkata → South Kolkata, from 2:00 PM to 10:00 PM.`
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    max_tokens: 500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            const botResponse = data.choices[0].message.content;
            
            hideTypingIndicator();
            addMessage(botResponse, 'bot');
        } catch (error) {
            hideTypingIndicator();
            addMessage(`Sorry, I couldn't process your request right now. Please try again later. 😔\n\nError: ${error.message}`, 'bot');
        } finally {
            document.getElementById('chat-send').disabled = false;
        }
    }

    function addMessage(content, sender) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${content}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'flex';
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'none';
    }

    function handleChatKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    // Initialize the app
    initializePandalList();

</script>
</html>
